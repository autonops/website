# InfraIQ Development Log

## 2026-01-05 (Sunday)

### Session: Phase 2 Clerk Authentication + Dashboard Settings + CLI Integration

**Duration:** ~4-5 hours

---

### Accomplishments

#### 1. Completed Clerk Authentication Integration

**Clerk Configuration:**
- Environment variables added to dashboard `.env.local` (gitignored)
- Vercel environment variables configured for production
- Middleware updated to use `authMiddleware` (Clerk v4 API)
- "Bypass Client Trust" enabled in Clerk dashboard to resolve 2FA hang

**Authentication Flow Working:**
- https://app.autonops.io redirects to sign-in
- Google OAuth and email authentication functional
- After sign-in redirects to `/dashboard`
- Clerk automatically links accounts with same email (no duplicates)

---

#### 2. Built User Management API Endpoints

**Created `POST /api/users/me`:**
- Upserts user on Clerk sign-in
- Creates new user with 30-day trial + API key (`iq_` prefix)
- Updates existing user email/name if changed
- Uses timezone-aware `datetime.now(timezone.utc)`

**Created `GET /api/users/me`:**
- Fetch user by Clerk ID
- Returns full user profile including API key and trial info

**Created `GET /api/users/me/stats`:**
- Returns scan counts: `scans_today`, `scans_this_month`, `scans_total`
- Filters by user's Clerk ID

**API Key Generation:**
```python
f"iq_{secrets.token_urlsafe(32)}"
```

---

#### 3. Fixed Critical Auth Bug

**Problem:** All scans were created with `user_id="api_user"` regardless of who pushed them.

**Root Cause:** `services/auth.py` returned a hardcoded string for all API key requests instead of looking up the actual user.

**Fix:** Updated `get_current_user_id()` to:
- Check if API key starts with `iq_`
- Look up user in database by API key
- Return the user's `clerk_id` as the user_id

**File:** `apps/api/services/auth.py`

```python
if x_api_key.startswith("iq_"):
    query = select(User).where(User.api_key == x_api_key)
    result = await db.execute(query)
    user = result.scalar_one_or_none()
    if user:
        return user.clerk_id
```

---

#### 4. Created Dashboard Settings Page

**Moved to:** `/dashboard/settings` (uses dashboard layout with sidebar)

**Features:**
- Account info (email, name, plan, trial days remaining)
- API key display with show/hide toggle (Eye/EyeOff icons)
- Copy button with checkmark feedback
- CLI configuration example
- Real-time usage stats from API

**Theming:** Inherits dashboard dark/light mode via CSS variables

**Files Created/Modified:**
- `apps/dashboard/app/dashboard/settings/page.tsx` (new)
- `apps/dashboard/components/layout/sidebar.tsx` (updated links)
- `apps/dashboard/lib/api.ts` (added user functions)
- Removed old `apps/dashboard/app/settings/` folder

---

#### 5. Fixed Technical Issues

| Issue | Error | Fix |
|-------|-------|-----|
| UUID type mismatch | `column "id" is of type uuid but expression is of type character varying` | Changed model from `Column(String)` to `Column(UUID(as_uuid=True), default=uuid_module.uuid4)` |
| Timezone-aware datetime | `can't subtract offset-naive and offset-aware datetimes` | Changed from `datetime.utcnow()` to `datetime.now(timezone.utc)` |
| Metadata in client component | `You are attempting to export "metadata" from a component marked with "use client"` | Removed metadata export from client component |
| CLI alias shadowing | `infraiq` command outputting nothing | Removed shell alias that was shadowing the installed package |

---

#### 6. Tested Full End-to-End Flow

1. ✅ User signs in via Clerk
2. ✅ Dashboard calls `POST /api/users/me` to create/update user
3. ✅ User gets API key + 30-day trial
4. ✅ User copies API key from Settings page
5. ✅ User configures CLI: `infraiq sync configure --api-key`
6. ✅ CLI pushes scan: `infraiq sync push scan.json`
7. ✅ Scan associated with correct user_id (Clerk ID)
8. ✅ Settings page shows updated usage stats

---

### Files Created/Modified

**API (`apps/api/`):**
- `routers/users.py` - User management endpoints with stats
- `services/auth.py` - Fixed to look up users by API key
- `models/user.py` - UUID type fix, timezone-aware properties

**Dashboard (`apps/dashboard/`):**
- `app/dashboard/settings/page.tsx` - New settings page
- `components/layout/sidebar.tsx` - Updated navigation links
- `lib/api.ts` - Added `upsertUser`, `getUser`, `getUserStats`
- `hooks/useUserSync.ts` - React hook for user sync (created earlier)

---

### API Endpoints Summary

| Method | Endpoint | Purpose |
|--------|----------|---------|
| POST | `/api/users/me` | Create/update user after Clerk sign-in |
| GET | `/api/users/me?clerk_id=xxx` | Get user by Clerk ID |
| GET | `/api/users/me/stats?clerk_id=xxx` | Get user's scan statistics |
| POST | `/api/scans` | Create scan (CLI sync) - now with correct user_id |
| GET | `/api/scans` | List user's scans (filtered by user_id) |

---

### Deployment

**API Deployed:**
- Multiple revisions deployed via `./deploy.sh`
- Final revision: `infraiq-api-00032-rpf`
- Service URL: https://api.autonops.io

**Dashboard Deployed:**
- Auto-deployed via Vercel from main branch
- URL: https://app.autonops.io

---

### Architecture

```
┌─────────────────┐     Clerk Auth     ┌─────────────────┐
│                 │◄──────────────────►│                 │
│    Dashboard    │                    │      Clerk      │
│    (Vercel)     │                    │                 │
│                 │                    └─────────────────┘
└────────┬────────┘
         │ POST /api/users/me
         │ GET /api/users/me/stats
         ▼
┌─────────────────┐                    ┌─────────────────┐
│                 │◄──────────────────►│                 │
│      API        │   Cloud SQL        │   PostgreSQL    │
│  (Cloud Run)    │                    │   (infraiq-db)  │
│                 │                    │                 │
└────────▲────────┘                    └─────────────────┘
         │ POST /api/scans
         │ X-API-Key: iq_xxx
         │
┌────────┴────────┐
│                 │
│   InfraIQ CLI   │
│   (Local)       │
│                 │
└─────────────────┘
```

---

### Key Learnings

1. **API Key Prefixing:** Using `iq_` prefix makes it easy to identify user API keys vs internal keys
2. **Timezone Awareness:** Always use `datetime.now(timezone.utc)` in Python for consistent UTC timestamps
3. **Shell Aliases:** Can shadow installed package entry points - use `unalias` to debug
4. **Clerk v4 API:** Uses `authMiddleware` not `clerkMiddleware`
5. **Next.js Client Components:** Cannot export `metadata` from `'use client'` components

---

### Commits

- `fix: timezone-aware datetimes and UUID type for user model`
- `feat: move settings to dashboard layout, add show/hide API key icons`
- `feat: add user stats endpoint and wire up settings usage section`
- `fix: authenticate users by personal API key, associate scans with user`

---

### Next Steps (Future Sessions)

- [ ] Add scan history view on dashboard
- [ ] Implement license tier enforcement
- [ ] Add team collaboration features
- [ ] Build tool-specific pages (VerifyIQ, MigrateIQ, etc.)
- [ ] Phase 3: Migrate license server to use infraiq-db

---

*Session ended: Full Clerk auth + CLI integration working end-to-end.*
